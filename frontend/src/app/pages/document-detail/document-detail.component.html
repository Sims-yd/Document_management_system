<div class="page-container" *ngIf="doc">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a routerLink="/documents" class="text-decoration-none">Documents</a></li>
        <li class="breadcrumb-item active text-truncate" style="max-width: 300px;" aria-current="page">{{ doc.title }}</li>
      </ol>
    </nav>
    <div class="d-flex gap-2">
      <a [href]="doc.fileUrl" target="_blank" class="btn btn-outline-primary">
        <i class="bi bi-download me-2"></i> Download
      </a>
      <button *ngIf="['Editor', 'Admin'].includes(userRole)" class="btn btn-outline-danger" (click)="deleteDocument()">
        <i class="bi bi-trash me-2"></i> Delete
      </button>
    </div>
  </div>

  <div class="row g-4">
    <!-- Main Content: Preview -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body p-0 d-flex align-items-center justify-content-center bg-subtle rounded overflow-hidden position-relative" style="min-height: 600px;">
          
          <!-- Loading State -->
          <div *ngIf="loading || mediaLoading['image'] || mediaLoading['video'] || mediaLoading['document']" 
               class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75" 
               style="z-index: 10;">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p class="text-muted fw-medium">Loading preview...</p>
          </div>

          <!-- Image Preview -->
          <img *ngIf="getMediaType(doc) === 'image'" 
               [src]="doc.fileUrl" 
               alt="{{ doc.title }}"
               (load)="onImageLoad()"
               (error)="onImageError()"
               [style.display]="mediaLoading['image'] ? 'none' : 'block'"
               class="img-fluid" style="max-height: 800px;">

          <!-- Video Preview -->
          <video *ngIf="getMediaType(doc) === 'video'" 
                 [src]="sanitizedFileUrl"
                 (loadedmetadata)="onVideoLoad()"
                 (error)="onVideoError()"
                 [style.display]="mediaLoading['video'] ? 'none' : 'block'"
                 class="w-100" style="max-height: 800px;"
                 controls controlsList="nodownload">
            Your browser does not support the video tag.
          </video>

          <!-- PDF/Doc Preview -->
          <iframe *ngIf="['pdf', 'document'].includes(getMediaType(doc)) && !mediaLoading['document']"
                  [src]="sanitizedFileUrl"
                  class="w-100 h-100 border-0"
                  style="min-height: 800px;"
                  title="Document Preview">
          </iframe>

          <!-- Fallback -->
          <div *ngIf="getMediaType(doc) === 'unknown'" class="text-center p-5">
            <i class="bi bi-file-earmark-break fs-1 text-muted mb-3"></i>
            <p class="text-muted">Preview not available for this file type.</p>
            <a [href]="doc.fileUrl" class="btn btn-primary btn-sm">Download to View</a>
          </div>

        </div>
      </div>
    </div>

    <!-- Sidebar: Metadata -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-bottom">
          <h5 class="mb-0 fw-bold">Details</h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <label class="text-muted small text-uppercase fw-bold mb-1">Description</label>
            <p class="mb-0">{{ doc.description || 'No description provided.' }}</p>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-6">
              <label class="text-muted small text-uppercase fw-bold mb-1">Category</label>
              <div><span class="badge bg-secondary bg-opacity-10 text-secondary">{{ doc.category }}</span></div>
            </div>
            <div class="col-6">
              <label class="text-muted small text-uppercase fw-bold mb-1">Version</label>
              <div class="fw-medium">v{{ doc.version }}</div>
            </div>
            <div class="col-6">
              <label class="text-muted small text-uppercase fw-bold mb-1">Uploaded By</label>
              <div class="d-flex align-items-center gap-2">
                <div class="avatar bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 10px;">
                  {{ doc.uploadedBy?.username?.charAt(0)?.toUpperCase() }}
                </div>
                <span>{{ doc.uploadedBy?.username }}</span>
              </div>
            </div>
            <div class="col-6">
              <label class="text-muted small text-uppercase fw-bold mb-1">Date</label>
              <div class="text-muted small">{{ doc.createdAt | date:'mediumDate' }}</div>
            </div>
          </div>

          <div class="mb-0">
            <label class="text-muted small text-uppercase fw-bold mb-2">Tags</label>
            <div class="d-flex flex-wrap gap-2">
              <span *ngFor="let tag of doc.tags" class="badge bg-subtle text-muted border">
                {{ tag }}
              </span>
              <span *ngIf="!doc.tags?.length" class="text-muted small">No tags</span>
            </div>
          </div>
        </div>
      </div>

      <!-- History (Mock/Real) -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-bottom">
          <h5 class="mb-0 fw-bold">Version History</h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <div *ngFor="let item of history" class="list-group-item border-0 px-4 py-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-medium">Version {{ item.version }}</span>
                <small class="text-muted">{{ item.timestamp | date:'shortDate' }}</small>
              </div>
              <small class="text-muted d-block">Updated by {{ item.modifiedBy?.username || 'System' }}</small>
            </div>
            <div *ngIf="history.length === 0" class="p-4 text-center text-muted small">
              No history available.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="error" class="container mt-5 text-center">
  <div class="alert alert-danger d-inline-flex align-items-center gap-2">
    <i class="bi bi-exclamation-triangle-fill"></i>
    {{ error }}
  </div>
  <div class="mt-3">
    <a routerLink="/documents" class="btn btn-secondary">Back to Documents</a>
  </div>
</div>
